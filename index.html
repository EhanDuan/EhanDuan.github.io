<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Kevin&#39;s Personal Tech Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Kevin&#39;s Personal Tech Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Kevin Duan">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kevin's Personal Tech Blog</title>
  
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-5NQQ2TS37M","only_pageview":true}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Kevin's Personal Tech Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Kevin Duan"
      src="/images/shiba.jpeg">
  <p class="site-author-name" itemprop="name">Kevin Duan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/EhanDuan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;EhanDuan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/10/SpringBoot-Shutdown/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/10/SpringBoot-Shutdown/" class="post-title-link" itemprop="url">SpringBoot Shutdown</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-09-10 16:09:50 / Modified: 16:36:49" itemprop="dateCreated datePublished" datetime="2023-09-10T16:09:50-05:00">2023-09-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Work-Tips/" itemprop="url" rel="index"><span itemprop="name">Work Tips</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Work-Tips/Interview-Questions/" itemprop="url" rel="index"><span itemprop="name">Interview Questions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h1><p>During an interview, a candidate was asked to the way shutdown a running springboot application gracefully. </p>
<p>We cannot use <code>System.exit()</code> in the application code. How do we do that?</p>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><h2 id="What-is-graceful-shutdown"><a href="#What-is-graceful-shutdown" class="headerlink" title="What is graceful shutdown?"></a>What is graceful shutdown?</h2><p>When application shutdowns, the resouces are occupied should be released, such as </p>
<ul>
<li><p>threadpool (like <code>shutdown()</code> and <code>shutdownNow()</code>)</p>
</li>
<li><p>socket links (netty and mq server)</p>
</li>
<li><p>Inform service registry shutdown </p>
</li>
<li><p>Clean temp file like using <code>poi</code></p>
<blockquote>
<p>Apache POI is a Java API used for manipulating Microsoft Office format files, allowing you to read, create, and modify various file formats such as Excel, Word, and PowerPoint files. When dealing with large amounts of data, you may encounter memory overflow issues because the Java Virtual Machine stores the data in memory when reading or writing a significant amount of data, leading to insufficient memory situations.</p>
</blockquote>
</li>
<li><p>In heap and out-of-heap memory release</p>
</li>
</ul>
<h2 id="Mock-a-downtime-with-Kill-9"><a href="#Mock-a-downtime-with-Kill-9" class="headerlink" title="Mock a downtime with Kill -9"></a>Mock a downtime with <code>Kill -9</code></h2><ul>
<li><p>find process id</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; jps -l</span><br><span class="line"></span><br><span class="line">9791 com.kevin.exceldemo.ExcelDemoApplication</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Kill it with 9</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 9791</span><br></pre></td></tr></table></figure>

<p>There is console of springboot</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process finished with exit code 137 (interrupted by signal 9: SIGKILL)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>KILL (9) − <strong>This signal is used to immediately terminate a process, without allowing it to clean up or save any data</strong>. This signal cannot be ignored by the process</p>
</blockquote>
<p>Besides, we could try -15 which is more graceful than -9.</p>
<blockquote>
<p> <strong>(signal 15) is a request to the program to terminate</strong>. If the program has a signal handler for SIGTERM that does not actually terminate the application, this kill may have no effect. This is the default signal sent by kill.</p>
</blockquote>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>By integrating actuator, we can send post request for shutdown.</p>
<ul>
<li><p>Add maven dependency</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</li>
<li><p>Expose endpoint in application.properties</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">jmx:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>send post request <code>curl -X POST localhost:port/actuator/shutdown</code></p>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/2SFGRdYnTUHHJpexf7dv2Q">https://mp.weixin.qq.com/s/2SFGRdYnTUHHJpexf7dv2Q</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/22/SimpleDateFormat-not-Thread-Safe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/22/SimpleDateFormat-not-Thread-Safe/" class="post-title-link" itemprop="url">SimpleDateFormat not Thread-Safe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-22 11:31:05 / Modified: 12:19:53" itemprop="dateCreated datePublished" datetime="2023-08-22T11:31:05-05:00">2023-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Work-Tips/" itemprop="url" rel="index"><span itemprop="name">Work Tips</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><p>In a commonly used constants class, we have a date formatter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonConstants</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATE_PATTERN</span> <span class="operator">=</span> <span class="string">&quot;MM/dd/yy&quot;</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">DateFormat</span> <span class="variable">DATE_FORMAT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(DATE_PATTERN);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>It is raised by rule <a target="_blank" rel="noopener" href="https://rules.sonarsource.com/java/RSPEC-2885/">S2885</a> Non-thread-safe fields should not be static.</p>
<blockquote>
<p>When an object is marked as <code>static</code>, it means that it belongs to the class rather than any class instance. This means there is only one copy of the static object in memory, regardless of how many class instances are created. Static objects are shared among all instances of the class and can be accessed using the class name rather than an instance of the class.</p>
<p>A data type is considered thread-safe if it can be used correctly by multiple threads, regardless of how those threads are executed, without requiring additional coordination from the calling code. In other words, a thread-safe data type can be accessed and modified by multiple threads simultaneously without causing any issues or requiring extra work from the programmer to ensure correct behavior.</p>
<p>Non-thread-safe objects are objects that are not designed to be used in a multi-threaded environment and can lead to race conditions and data inconsistencies when accessed by multiple threads simultaneously. Using them in a multi-threaded manner is highly likely to cause data problems or exceptions at runtime.</p>
<p>When a non-thread-safe object is marked as static in a multi-threaded environment, it can cause issues because the non-thread-safe object will be shared across different instances of the containing class.</p>
<p>This rule raises an issue when any of the following instances and their subtypes are marked as <code>static</code>:</p>
<ul>
<li><code>java.util.Calendar</code>,</li>
<li><code>java.text.DateFormat</code>,</li>
<li><code>javax.xml.xpath.XPath</code>, or</li>
<li><code>javax.xml.validation.SchemaFactory</code>.</li>
</ul>
</blockquote>
<h2 id="Reason"><a href="#Reason" class="headerlink" title="Reason"></a>Reason</h2><p>SimpleDateFormat is <strong>not</strong> designed in <strong>thread-safe</strong> manner. There would be error when multiple threads works on the same instance of the class.</p>
<p>The main reason is <code>SimpleDateFormat</code> use a <code>Calendar</code> object internally to store the date information.</p>
<p>Source code of constructor of <code>SimpleDateFormat</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SimpleDateFormat</span><span class="params">(String pattern, Locale locale)</span> &#123;</span><br><span class="line">	<span class="built_in">super</span>();</span><br><span class="line">	calendar = <span class="keyword">new</span> <span class="title class_">GregorianCalendar</span>(locale);</span><br></pre></td></tr></table></figure>



<p>Internally, <code>simpleDateFormat.format(Date date)</code> calls below method. Here, <code>calendar</code> is applied.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StringBuffer <span class="title function_">format</span><span class="params">(Date date, StringBuffer toAppendTo,</span></span><br><span class="line"><span class="params">                            FieldDelegate delegate)</span> &#123;</span><br><span class="line">    <span class="comment">// Convert input date to time field list</span></span><br><span class="line">    calendar.setTime(date);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In high concurrency, this set method will cause race condition.</p>
<p>Reference:</p>
<p><a target="_blank" rel="noopener" href="http://fahdshariff.blogspot.com/2010/08/dateformat-with-multiple-threads.html">DateFormat with Multiple Threads</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/csdn_ds/article/details/72984646">SimpleDateFormat线程不安全及解决办法</a></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Change to <code>DateTimeFormatter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">DateTimeFormatter</span> <span class="variable">FORMATTER</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(DATE_PATTERN)</span><br></pre></td></tr></table></figure>

<p>Note: we need to parse Date to LocalDate in order to parse. Here is an example code.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateToStringExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a java.util.Date object (replace this with your desired date)</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">legacyDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert the java.util.Date to java.time.LocalDate</span></span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">localDate</span> <span class="operator">=</span> legacyDate.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Define your desired date format</span></span><br><span class="line">        <span class="type">DateTimeFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">formattedDate</span> <span class="operator">=</span> localDate.format(formatter);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Formatted Date: &quot;</span> + formattedDate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/22/Tips-of-Equals-Method/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/22/Tips-of-Equals-Method/" class="post-title-link" itemprop="url">Tips of Equals Method</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-22 11:30:08" itemprop="dateCreated datePublished" datetime="2023-08-22T11:30:08-05:00">2023-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-29 16:19:24" itemprop="dateModified" datetime="2023-08-29T16:19:24-05:00">2023-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Work-Tips/" itemprop="url" rel="index"><span itemprop="name">Work Tips</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><p>SonarQube indicates following code (dummy) raises a <strong>reliability</strong> issue&#x2F;bug</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">if</span> (obj.getType().equals(<span class="string">&quot;excel&quot;</span>))</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (obj.getType().equals(<span class="string">&quot;other&quot;</span>))</span><br><span class="line">  <span class="comment">// do others</span></span><br></pre></td></tr></table></figure>

<p>The triggered rule is <a target="_blank" rel="noopener" href="https://rules.sonarsource.com/java/RSPEC-2259/">S2259</a>:  Null Pointers should not be dereferenced.</p>
<blockquote>
<p>A reference to <code>null</code> should never be dereferenced&#x2F;accessed. Doing so will cause a <code>NullPointerException</code> to be thrown. At best, such an exception will cause abrupt program termination. At worst, it could expose debugging information that would be useful to an attacker, or it could allow an attacker to bypass security measures.</p>
</blockquote>
<h2 id="Reason"><a href="#Reason" class="headerlink" title="Reason"></a>Reason</h2><p>In the above code, <code>obj.getType()</code> could be <code>null</code>. So in this case, it will raise NPE.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>change to above code to below</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Objects.equals(obj.getType(), <span class="string">&quot;excel&quot;</span>))</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>



<p>A quick test on jshell.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jshell&gt; String a;</span><br><span class="line">a ==&gt; null</span><br><span class="line"></span><br><span class="line">jshell&gt; a.equals(&quot;&quot;)</span><br><span class="line">|  Exception java.lang.NullPointerException: Cannot invoke &quot;String.equals(Object)&quot; because &quot;REPL.$JShell$11.a&quot; is null</span><br><span class="line">|        at (#2:1)</span><br><span class="line"></span><br><span class="line">jshell&gt; Objects.equals(a, &quot;&quot;)</span><br><span class="line">$3 ==&gt; false</span><br></pre></td></tr></table></figure>








      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/05/SpringBoot-AWS-RDS-with-Secrets-Manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/05/SpringBoot-AWS-RDS-with-Secrets-Manager/" class="post-title-link" itemprop="url">SpringBoot AWS RDS with Secrets Manager</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-07-05 10:01:20 / Modified: 12:22:58" itemprop="dateCreated datePublished" datetime="2023-07-05T10:01:20-05:00">2023-07-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/manual/" itemprop="url" rel="index"><span itemprop="name">manual</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h1><p>The project is developed following these tutorials.</p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Tbf7F42tcBw">Amazon RDS | Deploy Spring Boot + MySQL CRUD Application into Elastic Beanstalk | JavaTechie</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=ePTNs3pqVvg">Spring Boot | Manage your credentials using AWS Secrets Manager | RDS | JavaTechie</a></p>
<h1 id="AWS-RDS"><a href="#AWS-RDS" class="headerlink" title="AWS RDS"></a>AWS RDS</h1><ol>
<li>Create rds database</li>
<li>update security group inbound rule</li>
<li>copy endpoint</li>
</ol>
<h1 id="AWS-Secrets-Manager"><a href="#AWS-Secrets-Manager" class="headerlink" title="AWS Secrets Manager"></a>AWS Secrets Manager</h1><ol>
<li>click “Store a new secret’’</li>
<li>choose RDS and select target db</li>
<li>type username password</li>
<li>copy the code snippet ( not work on my side, using other code, shown in debug)</li>
</ol>
<h1 id="AWS-IAM"><a href="#AWS-IAM" class="headerlink" title="AWS IAM"></a>AWS IAM</h1><p><strong>add secrets manager policy to the user.</strong></p>
<h1 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h1><p>Properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"># spring.datasource.url=jdbc:mysql://demo-book-instance.cmp39fwzrerm.us-east-2.rds.amazonaws.com:3306/demo</span></span><br><span class="line"><span class="comment"># spring.datasource.username=root</span></span><br><span class="line"><span class="comment">#spring.datasource.password=1008610086</span></span><br><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">update</span></span><br><span class="line"><span class="attr">spring.jpa.show-sql</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.jpa.database-platform</span>=<span class="string">org.hibernate.dialect.MySQL5Dialect</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cloud.aws.credentials.accessKey</span>=<span class="string">accessKey</span></span><br><span class="line"><span class="attr">cloud.aws.credentials.secretKey</span>=<span class="string">secretKey</span></span><br></pre></td></tr></table></figure>



<p>create config class to include get secret logic</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aws_rds_secret.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.amazonaws.auth.AWSStaticCredentialsProvider;</span><br><span class="line"><span class="keyword">import</span> com.amazonaws.auth.BasicAWSCredentials;</span><br><span class="line"><span class="keyword">import</span> com.amazonaws.services.secretsmanager.AWSSecretsManager;</span><br><span class="line"><span class="keyword">import</span> com.amazonaws.services.secretsmanager.AWSSecretsManagerClientBuilder;</span><br><span class="line"><span class="keyword">import</span> com.amazonaws.services.secretsmanager.model.GetSecretValueRequest;</span><br><span class="line"><span class="keyword">import</span> com.amazonaws.services.secretsmanager.model.GetSecretValueResult;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> software.amazon.awssdk.regions.Region;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cloud.aws.credentials.accessKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cloud.aws.credentials.secretKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// build data source object</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AwsSecrets</span> <span class="variable">awsSecrets</span> <span class="operator">=</span> getSecret();</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create()</span><br><span class="line"><span class="comment">//                .driverClassName(&quot;com.mysql.cj.jdbc.driver&quot;)</span></span><br><span class="line">                .url(<span class="string">&quot;jdbc:&quot;</span> + awsSecrets.getEngine() + <span class="string">&quot;://&quot;</span> +awsSecrets.getHost() + <span class="string">&quot;:&quot;</span> + awsSecrets.getPort() + <span class="string">&quot;/demo&quot;</span>)</span><br><span class="line">                .username(awsSecrets.getUsername())</span><br><span class="line">                .password(awsSecrets.getPassword())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AwsSecrets <span class="title function_">getSecret</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">secretName</span> <span class="operator">=</span> <span class="string">&quot;demo-db-credential&quot;</span>;</span><br><span class="line">        <span class="type">Region</span> <span class="variable">region</span> <span class="operator">=</span> Region.of(<span class="string">&quot;us-east-2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a Secrets Manager client</span></span><br><span class="line">        <span class="type">AWSSecretsManager</span> <span class="variable">client</span> <span class="operator">=</span> AWSSecretsManagerClientBuilder.standard()</span><br><span class="line">                .withRegion(<span class="string">&quot;us-east-2&quot;</span>)</span><br><span class="line">                .withCredentials(<span class="keyword">new</span> <span class="title class_">AWSStaticCredentialsProvider</span>(<span class="keyword">new</span> <span class="title class_">BasicAWSCredentials</span>(</span><br><span class="line">                        accessKey,</span><br><span class="line">                        secretKey</span><br><span class="line">                )))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">GetSecretValueRequest</span> <span class="variable">getSecretValueRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetSecretValueRequest</span>()</span><br><span class="line">                .withSecretId(secretName);</span><br><span class="line"></span><br><span class="line">        GetSecretValueResult getSecretValueResult;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getSecretValueResult = client.getSecretValue(getSecretValueRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// For a list of exceptions thrown, see</span></span><br><span class="line">            <span class="comment">// https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html</span></span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> getSecretValueResult.getSecretString();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Your code goes here.</span></span><br><span class="line">        System.out.println(<span class="string">&quot;secret: &quot;</span> + secret);</span><br><span class="line">        <span class="keyword">return</span> gson.fromJson(secret, AwsSecrets.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In addition, create an <code>AwsSecrets</code> class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aws_rds_secret.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AwsSecrets</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> String engine;</span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="keyword">private</span> String dbInstanceIdentifier;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="Debug-Collections"><a href="#Debug-Collections" class="headerlink" title="Debug Collections"></a>Debug Collections</h1><ol>
<li><p>Secret Manager : Access Denied &#x2F; no identity-based policy</p>
<p>reason: As the error message suggests, current accessKey and secretKey does not have secret manager policy.</p>
<p>solution: add <code>SecretsManagerReadWrite</code> policy</p>
</li>
<li><p>Code that is present on AWS page doesn’t work out of the box</p>
<p>Reason: not sure </p>
<p>Solution: change the template code to [video](code that is present on AWS page doesn’t work out of the box) </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AwsSecrets <span class="title function_">getSecret</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">secretName</span> <span class="operator">=</span> <span class="string">&quot;demo-db-credential&quot;</span>;</span><br><span class="line">    <span class="type">Region</span> <span class="variable">region</span> <span class="operator">=</span> Region.of(<span class="string">&quot;us-east-2&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// Create a Secrets Manager client</span></span><br><span class="line">    <span class="type">AWSSecretsManager</span> <span class="variable">client</span> <span class="operator">=</span> AWSSecretsManagerClientBuilder.standard()</span><br><span class="line">            .withRegion(<span class="string">&quot;us-east-2&quot;</span>)</span><br><span class="line">            .withCredentials(<span class="keyword">new</span> <span class="title class_">AWSStaticCredentialsProvider</span>(<span class="keyword">new</span> <span class="title class_">BasicAWSCredentials</span>(</span><br><span class="line">                    accessKey,</span><br><span class="line">                    secretKey</span><br><span class="line">            )))</span><br><span class="line">            .build();</span><br><span class="line">   </span><br><span class="line">    <span class="type">GetSecretValueRequest</span> <span class="variable">getSecretValueRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetSecretValueRequest</span>()</span><br><span class="line">            .withSecretId(secretName);</span><br><span class="line">   </span><br><span class="line">    GetSecretValueResult getSecretValueResult;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getSecretValueResult = client.getSecretValue(getSecretValueRequest);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// For a list of exceptions thrown, see</span></span><br><span class="line">        <span class="comment">// https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> getSecretValueResult.getSecretString();</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// Your code goes here.</span></span><br><span class="line">    System.out.println(<span class="string">&quot;secret: &quot;</span> + secret);</span><br><span class="line">    <span class="keyword">return</span> gson.fromJson(secret, AwsSecrets.class);</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>remember to add <code>@GeneratedValue(strategy = GenerationType.IDENTITY)</code> on entity id.</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/04/SpringBoot-CQRS-with-Axon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/04/SpringBoot-CQRS-with-Axon/" class="post-title-link" itemprop="url">SpringBoot CQRS with Axon</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-07-04 19:01:22 / Modified: 22:48:43" itemprop="dateCreated datePublished" datetime="2023-07-04T19:01:22-05:00">2023-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Manual/" itemprop="url" rel="index"><span itemprop="name">Manual</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CQRS"><a href="#CQRS" class="headerlink" title="CQRS"></a>CQRS</h1><p>CQRS stands for Command and Query Responsibility Segregation, a pattern that separates read and update operations for a data store. Implementing CQRS in your application can maximize its performance, scalability, and security</p>
<p>Problems it solved:</p>
<ul>
<li>There is often a mismatch between the read and write representations of the data, such as additional columns or properties that must be updated correctly even though they aren’t required as part of an operation.</li>
</ul>
<ul>
<li>Managing security and permissions can become complex, because each entity is subject to both read and write operations, which might expose data in the wrong context.</li>
</ul>
<p>There are some benefits from <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs">CQRS pattern</a>:</p>
<ul>
<li><strong>Optimized data schemas</strong>. The read side can use a schema that is optimized for queries, while the write side uses a schema that is optimized for updates.</li>
</ul>
<ul>
<li><p><strong>Security</strong>. It’s easier to ensure that only the right domain entities are performing writes on the data.</p>
</li>
<li><p><strong>Separation of concerns</strong>. Segregating the read and write sides can result in models that are more maintainable and flexible. Most of the complex business logic goes into the write model. The read model can be relatively simple.</p>
</li>
<li><p><strong>Independent scaling</strong>. CQRS allows the read and write workloads to scale independently, and may result in fewer lock contentions.</p>
</li>
</ul>
<h1 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h1><p>I was following this <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=sthMcMrspCM">video tutorial</a> with some modifications.</p>
<p>We have a single application with command package and query package. They share <strong>same</strong> H2 db in memory. </p>
<blockquote>
<p>Usually, command and query should use different databases for better performance. Here is for simplicity. However, it is not binary. There are some <a target="_blank" rel="noopener" href="https://k.sina.cn/article_1708729084_65d922fc034002anx.html">dicussions</a> between single database or different databases.</p>
</blockquote>
<p><strong>Environment</strong>: SpringBoot 2.7.13 + Axon 4.5.10 + H2 + Spring Data JPA</p>
<p>Here only creation and query are realized. Here is the workflow of creation</p>
<pre><code class="highlight mermaid">graph TD

API --POST /product--&gt; Controller --createProductCommand--&gt; CommandGateway --createProductCommand--&gt; Aggregate --publish--&gt; EventStore --be listened--&gt; EventsHandler --&gt; repository --&gt; db</code></pre>



<h2 id="Axon"><a href="#Axon" class="headerlink" title="Axon"></a>Axon</h2><p>run in docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name axonserver \</span><br><span class="line">  -p 8024:8024 \</span><br><span class="line">  -p 8124:8124 \</span><br><span class="line">  axoniq/axonserver:&lt;TAG&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Visit <a target="_blank" rel="noopener" href="https://hub.docker.com/r/axoniq/axonserver">Axon Server on Docker Hub</a> for the list of available tags and their meaning. </p>
</blockquote>
<p>Here I use following command.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line"> --name axonserver \</span><br><span class="line"> -p 8024:8024 \</span><br><span class="line"> -p 8124:8124 \</span><br><span class="line"> axoniq/axonserver:4.6.9-jdk-8-dev</span><br></pre></td></tr></table></figure>



<p>Visit <a target="_blank" rel="noopener" href="http://localhost:8024/">http://localhost:8024</a> to check success or not.</p>
<p>Reference: <a target="_blank" rel="noopener" href="https://developer.axoniq.io/download">https://developer.axoniq.io/download</a></p>
<h2 id="H2"><a href="#H2" class="headerlink" title="H2"></a>H2</h2><p>Here is the configuration of H2 in properties file.</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:h2:mem:productDB</span></span><br><span class="line"><span class="attr">spring.datasource.driverClassName</span>=<span class="string">org.h2.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">sa</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">password</span></span><br><span class="line"><span class="attr">spring.jpa.database-platform</span>=<span class="string">org.hibernate.dialect.H2Dialect</span></span><br><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">update</span></span><br><span class="line"><span class="attr">spring.h2.console.settings.web-allow-others</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.h2.console.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>reference: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/flydean/p/12680291.html">https://www.cnblogs.com/flydean/p/12680291.html</a></p>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- root</span><br><span class="line">  - data</span><br><span class="line">  - model</span><br><span class="line">  - repository</span><br><span class="line">  - command.api</span><br><span class="line">    - aggregate</span><br><span class="line">    - commands</span><br><span class="line">    - events</span><br><span class="line">    - controller</span><br><span class="line">    - exception</span><br><span class="line">  - query.api</span><br><span class="line">    - controller</span><br><span class="line">    - projections</span><br><span class="line">    - queries</span><br></pre></td></tr></table></figure>

<p>Compared with video, I moved <code>data</code> and <code>repository</code> out of command and query. They can be origanized into <code>core</code> package or <code>common</code> package, allowing others to use.</p>
<blockquote>
<p>data here is entity or domain.</p>
<p>aggregate is like a middle layer between command gateway and event store.</p>
</blockquote>
<p>When I try to undertand and develop the worflow, it is better from controller like a request flow diagram above.</p>
<h2 id="Command-API"><a href="#Command-API" class="headerlink" title="Command API"></a>Command API</h2><p>In command controller, we have <code>CommandGateway</code> as dependency.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.command.api.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.command.api.commands.CreateProductCommand;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.model.ProductRestModel;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.commandhandling.gateway.CommandGateway;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/products&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductCommandController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CommandGateway commandGateway;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductCommandController</span><span class="params">(CommandGateway commandGateway)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.commandGateway = commandGateway;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addProduct</span><span class="params">(<span class="meta">@RequestBody</span> ProductRestModel productRestModel)</span> &#123;</span><br><span class="line">        <span class="type">CreateProductCommand</span> <span class="variable">createProductCommand</span> <span class="operator">=</span> CreateProductCommand</span><br><span class="line">                .builder()</span><br><span class="line">                .productId(UUID.randomUUID().toString())</span><br><span class="line">                .name(productRestModel.getName())</span><br><span class="line">                .price(productRestModel.getPrice())</span><br><span class="line">                .quantity(productRestModel.getQuantity())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> commandGateway.sendAndWait(createProductCommand);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>Then <code>CommandGateway</code> will send the command to  <code>Aggregate</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.command.api.aggregate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.command.api.commands.CreateProductCommand;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.command.api.events.ProductCreatedEvent;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.commandhandling.CommandHandler;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.eventsourcing.EventSourcingHandler;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.modelling.command.AggregateIdentifier;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.modelling.command.AggregateLifecycle;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.spring.stereotype.Aggregate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aggregate</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductAggregate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AggregateIdentifier</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer quantity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CommandHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductAggregate</span><span class="params">(CreateProductCommand createProductCommand)</span> &#123;</span><br><span class="line">        <span class="comment">// can perform validations here</span></span><br><span class="line">        <span class="type">ProductCreatedEvent</span> <span class="variable">productCreatedEvent</span> <span class="operator">=</span> ProductCreatedEvent.builder()</span><br><span class="line">                .productId(createProductCommand.getProductId())</span><br><span class="line">                .name(createProductCommand.getName())</span><br><span class="line">                .price(createProductCommand.getPrice())</span><br><span class="line">                .quantity(createProductCommand.getQuantity())</span><br><span class="line">                .build();</span><br><span class="line">        AggregateLifecycle.apply(productCreatedEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductAggregate</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventSourcingHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">on</span><span class="params">(ProductCreatedEvent productCreatedEvent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.productId = productCreatedEvent.getProductId();</span><br><span class="line">        <span class="built_in">this</span>.name = productCreatedEvent.getName();</span><br><span class="line">        <span class="built_in">this</span>.price = productCreatedEvent.getPrice();</span><br><span class="line">        <span class="built_in">this</span>.quantity = productCreatedEvent.getQuantity();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Here we need an eventSourcingHandler to handle event on command side.</p>
</blockquote>
<p>We also need a <code>CreateProductCommand</code> class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.command.api.commands;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.modelling.command.TargetAggregateIdentifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreateProductCommand</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetAggregateIdentifier</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer quantity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Same idea is the event class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.command.api.events;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductCreatedEvent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer quantity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>After that, we need an event handler to interact with repository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.command.api.events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.data.Product;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.repository.ProductRepository;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.eventhandling.EventHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductEventsHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProductRepository productRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductEventsHandler</span><span class="params">(ProductRepository productRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.productRepository = productRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">on</span><span class="params">(ProductCreatedEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// save entity to database</span></span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setProductId(event.getProductId());</span><br><span class="line">        product.setName(event.getName());</span><br><span class="line">        product.setPrice(event.getPrice());</span><br><span class="line">        product.setQuantity(event.getQuantity());</span><br><span class="line">        productRepository.save(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Finally, simple repository class.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.data.Product;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Product, String&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In this way, we complete the command side code.</p>
<h2 id="Query-API"><a href="#Query-API" class="headerlink" title="Query API"></a>Query API</h2><p>Start with controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.query.api.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.model.ProductRestModel;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.query.api.queries.GetProductsQuery;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.messaging.responsetypes.ResponseTypes;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.queryhandling.QueryGateway;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/products&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductQueryController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryGateway queryGateway;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductQueryController</span><span class="params">(QueryGateway queryGateway)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.queryGateway = queryGateway;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ProductRestModel&gt; <span class="title function_">getAllProducts</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GetProductsQuery</span> <span class="variable">getProductsQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetProductsQuery</span>();</span><br><span class="line">        List&lt;ProductRestModel&gt; productRestModels = queryGateway.query(getProductsQuery, ResponseTypes.multipleInstancesOf(ProductRestModel.class)).join();</span><br><span class="line">        <span class="keyword">return</span> productRestModels;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Query class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.query.api.queries;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetProductsQuery</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Projection class for interaction with repository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.query.api.projection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.data.Product;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.model.ProductRestModel;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.query.api.queries.GetProductsQuery;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.repository.ProductRepository;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.queryhandling.QueryHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductProjection</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProductRepository productRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductProjection</span><span class="params">(ProductRepository productRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.productRepository = productRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@QueryHandler</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ProductRestModel&gt; <span class="title function_">handle</span><span class="params">(GetProductsQuery getProductsQuery)</span> &#123;</span><br><span class="line">        List&lt;Product&gt; products = productRepository.findAll();</span><br><span class="line">        List&lt;ProductRestModel&gt; productRestModels = products.stream()</span><br><span class="line">                .map(p -&gt; ProductRestModel.builder()</span><br><span class="line">                        .name(p.getName())</span><br><span class="line">                        .price(p.getPrice())</span><br><span class="line">                        .quantity(p.getQuantity())</span><br><span class="line">                        .build())</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> productRestModels;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p> <code>ListenerInvocationErrorHandler</code> could handle rollback.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.command.api.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.axonframework.config.ProcessingGroup;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.eventhandling.EventMessage;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.eventhandling.EventMessageHandler;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.eventhandling.ListenerInvocationErrorHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ProcessingGroup(&quot;product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductServiceEventsErrorHandler</span> <span class="keyword">implements</span> <span class="title class_">ListenerInvocationErrorHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception e, EventMessage&lt;?&gt; eventMessage, EventMessageHandler eventMessageHandler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Configure in main class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CqrsApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(CqrsApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(EventProcessingConfigurer configurer)</span> &#123;</span><br><span class="line">        configurer.registerListenerInvocationErrorHandler(</span><br><span class="line">                <span class="string">&quot;product&quot;</span>,</span><br><span class="line">                configuration -&gt; <span class="keyword">new</span> <span class="title class_">ProductServiceEventsErrorHandler</span>()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lastly, add exception handler in <code>ProductEventsHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.cqrs.command.api.events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.data.Product;</span><br><span class="line"><span class="keyword">import</span> com.kevin.cqrs.repository.ProductRepository;</span><br><span class="line"><span class="keyword">import</span> org.axonframework.eventhandling.EventHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductEventsHandler</span> &#123;</span><br><span class="line"></span><br><span class="line"> 		<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>reference: <a target="_blank" rel="noopener" href="https://discuss.axoniq.io/t/rollback-changes-in-the-eventhandler-method-if-exception-takes-place/3171">https://discuss.axoniq.io/t/rollback-changes-in-the-eventhandler-method-if-exception-takes-place/3171</a></p>
<h1 id="Debug-Collections"><a href="#Debug-Collections" class="headerlink" title="Debug Collections"></a>Debug Collections</h1><ol>
<li><p>org.springframework.beans.factory.BeanCurrentlyInCreationException: Error creating bean with name ‘entityManagerFactory’: Requested bean is currently in creation: Is there an unresolvable circular reference?</p>
<p>Reason: there are some error in <strong>axon 4.5.3</strong></p>
<p>Solution: changed to <strong>4.5.10</strong></p>
<p>Reference:<a target="_blank" rel="noopener" href="https://discuss.axoniq.io/t/axon-springboot-and-postgres-jpa-entitymanagerfactory-error-on-startup/4146">Axon, Springboot and Postgres&#x2F;JPA entityManagerFactory error on startup</a></p>
<blockquote>
<p>Hi <a target="_blank" rel="noopener" href="https://discuss.axoniq.io/u/morlack">@Morlack</a>, I was running the <code>FoodCartApplication</code> directly in IntelliJ, not running the tests. After your comment I reverted my change to exclude <code>hibernate-core</code> from the <code>axon-spring-boot-starter</code> and bizarely everything was still working!</p>
<p>So, I reverted all local changes back to where things stood when I posted the issue and thankfully I got the same exception as reported, so I’m really pleased to say I’m not going mad! It appears to be an issue with the Axon version 4.5.1, after I had reported the issue I upgraded to 4.5.10 and I don’t see the same issue as previously.</p>
<p>So, at 4.5.1 it requires the hibernate exclusion, at 4.5.10 it doesn’t. I have pushed the version at 4.5.1 to <a target="_blank" rel="noopener" href="https://github.com/andye2004/axon-hibernate-issue">here 2</a>, please feel free to check it out and have a play if you want to get to the bottom of it.</p>
<p>Cheers, Andy.</p>
</blockquote>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/04/SpringBoot-with-AWS-DynamoDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/04/SpringBoot-with-AWS-DynamoDB/" class="post-title-link" itemprop="url">SpringBoot with AWS DynamoDB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-04 13:04:59" itemprop="dateCreated datePublished" datetime="2023-07-04T13:04:59-05:00">2023-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-05 10:02:01" itemprop="dateModified" datetime="2023-07-05T10:02:01-05:00">2023-07-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/manual/" itemprop="url" rel="index"><span itemprop="name">manual</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="AWS-DynamoDB"><a href="#AWS-DynamoDB" class="headerlink" title="AWS DynamoDB"></a>AWS DynamoDB</h1><p>Amazon DynamoDB is a fully managed, serverless, key-value NoSQL database designed to run high-performance applications at any scale.</p>
<h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><p>SpringBoot + AWS DynamoDB</p>
<h2 id="AWS-Preparation"><a href="#AWS-Preparation" class="headerlink" title="AWS Preparation"></a>AWS Preparation</h2><h3 id="IAM-and-Policy"><a href="#IAM-and-Policy" class="headerlink" title="IAM and Policy"></a>IAM and Policy</h3><ol>
<li>create IAM Group with <code>AmazonDynamoDBFullAccess</code>.</li>
<li>create a user within this group</li>
<li>Get <code>accessKey</code> and <code>secretKey</code>  of this user.</li>
</ol>
<h3 id="DynamoDB"><a href="#DynamoDB" class="headerlink" title="DynamoDB"></a>DynamoDB</h3><p>create a table with default setting, using <code>id</code> as paritition key</p>
<h2 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h2><ol>
<li><p>add aws dependency</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.amazonaws<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aws-java-sdk-dynamodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.338<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>add <code>accessKey</code> and <code>secretKey</code> to properties file</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aws.accessKey</span> = <span class="string">accessKey</span></span><br><span class="line"><span class="attr">aws.secretKey</span> = <span class="string">secretKey</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>create config class</p>
<p>Modify the endpoint config with your aws endpoints.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamodbConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aws.accessKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aws.secretKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DynamoDBMapper <span class="title function_">dynamoDBMapper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DynamoDBMapper</span>(amazonDynamoDB());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AmazonDynamoDB <span class="title function_">amazonDynamoDB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AmazonDynamoDBClientBuilder.standard()</span><br><span class="line">                .withEndpointConfiguration(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AwsClientBuilder</span>.EndpointConfiguration(</span><br><span class="line">                                <span class="string">&quot;dynamodb.us-east-2.amazonaws.com&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;us-east-2&quot;</span></span><br><span class="line"></span><br><span class="line">                        )</span><br><span class="line">                ).withCredentials(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AWSStaticCredentialsProvider</span>(</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">BasicAWSCredentials</span>(accessKey, secretKey)</span><br><span class="line">                        )</span><br><span class="line">                ).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create <code>Entity</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dynamodbdemo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.amazonaws.services.dynamodbv2.datamodeling.*;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@DynamoDBTable(tableName = &quot;dynamodbdemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@DynamoDBHashKey</span></span><br><span class="line">    <span class="meta">@DynamoDBAutoGeneratedKey</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamoDBAttribute</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamoDBAttribute</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamoDBAttribute</span></span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The reference type field should be marked with <code>@DynamoDBDocument</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dynamodbdemo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBDocument;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@DynamoDBDocument</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String addressId;</span><br><span class="line">    <span class="keyword">private</span> String addressLine1;</span><br><span class="line">    <span class="keyword">private</span> String addressLine2;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line">    <span class="keyword">private</span> String country;</span><br><span class="line">    <span class="keyword">private</span> String zipCode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: when creating new employee, no necessary to provide id. DynamoDB will generate a UUID automatically.</p>
</blockquote>
</li>
</ol>
<h1 id="Debug-Collections"><a href="#Debug-Collections" class="headerlink" title="Debug Collections"></a>Debug Collections</h1><ol>
<li><p>Unknown Host exception from the AWS Java client?</p>
<p>Reason: typo in service endpoint (in config class)</p>
<p>Solution: find correct endpoint via aws official doc. Here is a table of avaliable service endpoints: <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/general/latest/gr/ddb.html">https://docs.aws.amazon.com/general/latest/gr/ddb.html</a></p>
<table>
<thead>
<tr>
<th align="left">Region Name</th>
<th align="left">Region</th>
<th align="left">Endpoint</th>
<th align="left">Protocol</th>
</tr>
</thead>
<tbody><tr>
<td align="left">US East (Ohio)</td>
<td align="left">us-east-2</td>
<td align="left">dynamodb.us-east-2.amazonaws.comdynamodb-fips.us-east-2.amazonaws.com</td>
<td align="left">HTTP and HTTPSHTTPS</td>
</tr>
<tr>
<td align="left">US East (N. Virginia)</td>
<td align="left">us-east-1</td>
<td align="left">dynamodb.us-east-1.amazonaws.comdynamodb-fips.us-east-1.amazonaws.com</td>
<td align="left">HTTP and HTTPSHTTPS</td>
</tr>
<tr>
<td align="left">US West (N. California)</td>
<td align="left">us-west-1</td>
<td align="left">dynamodb.us-west-1.amazonaws.comdynamodb-fips.us-west-1.amazonaws.com</td>
<td align="left">HTTP and HTTPSHTTPS</td>
</tr>
<tr>
<td align="left">US West (Oregon)</td>
<td align="left">us-west-2</td>
<td align="left">dynamodb.us-west-2.amazonaws.comdynamodb-fips.us-west-2.amazonaws.com</td>
<td align="left">HTTP and HTTPSHTTPS</td>
</tr>
</tbody></table>
<p>Reference: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9723169/unknown-host-exception-from-the-aws-java-client">https://stackoverflow.com/questions/9723169/unknown-host-exception-from-the-aws-java-client</a>, </p>
</li>
<li><p>type [class java.util.UUID] is not supported; no conversion from class java.lang.Long</p>
<p>Reason: I used <code>long</code> type for employee <code>id</code>. It seems like aws dynamodb does not support <code>long</code> by default. </p>
<p>Solution: I changed to String. There maybe a way to use long</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/03/Spring-Cloud-Sleuth/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/03/Spring-Cloud-Sleuth/" class="post-title-link" itemprop="url">Spring Cloud Sleuth</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-03 21:53:31" itemprop="dateCreated datePublished" datetime="2023-07-03T21:53:31-05:00">2023-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-04 13:02:39" itemprop="dateModified" datetime="2023-07-04T13:02:39-05:00">2023-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Learning-Note/" itemprop="url" rel="index"><span itemprop="name">Learning Note</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-Cloud-Sleuth"><a href="#Spring-Cloud-Sleuth" class="headerlink" title="Spring Cloud Sleuth"></a>Spring Cloud Sleuth</h1><h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>In microservice system, it is hard to understand a complete request workflow since we need to rely on <strong>scattered entry logs</strong>. For example,  below is an instance in e-commerce scene:</p>
<pre><code class="highlight mermaid">graph LR
    OrderService--&gt;PaymentService --&gt; NotificationService--&gt;DeliveryService</code></pre>

<blockquote>
<p>Graph is generated using mermaid syntax. Here is a cheatsheet: <a target="_blank" rel="noopener" href="https://jojozhuang.github.io/tutorial/mermaid-cheat-sheet/">https://jojozhuang.github.io/tutorial/mermaid-cheat-sheet/</a></p>
</blockquote>
<p>In one request, we might need to manually find corresponding logs in each service, which could be time consuming. </p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Distributed tracing could help us to visualize request acrossing service boundaries. Spring Cloud Sleuth is powerful tool to realize this feature. </p>
<p>In addition, using Zipkin could help to visualize the result in more elegant way. One use case is investigation of bottleneck by checking process duration of each service in one request flow.</p>
<p>Spring cloud Sleuth logs are printed in the following format −</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[application-name,traceid,spanid,zipkin-export]</span><br></pre></td></tr></table></figure>



<h1 id="Demo-Project"><a href="#Demo-Project" class="headerlink" title="Demo Project"></a>Demo Project</h1><pre><code class="highlight mermaid">graph LR
    OrderService--&gt;PaymentService</code></pre>

<p>Here,  2 microservices is built here. OrderService sends HTTP request via RestTemplate to PaymentService. </p>
<h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><p> Spring Boot 2.7.X + MySQL + Sleuth + Zipkin (Docker) + Spring Data JPA</p>
<h3 id="SpringBoot-Project-Structure"><a href="#SpringBoot-Project-Structure" class="headerlink" title="SpringBoot Project Structure"></a>SpringBoot Project Structure</h3><p>We have a parent project : sleuth. And 2 children project: orderService and paymentService. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--sleuth</span><br><span class="line">  |--- orderService</span><br><span class="line">  |--- paymentService</span><br></pre></td></tr></table></figure>



<p>Since we do not execute on parent project, delete following files or dir in parent project.</p>
<ul>
<li>src</li>
<li>.mvn</li>
<li>mvnw</li>
<li>mvnw.cmd</li>
</ul>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>Configure database</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/orderService</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">password</span></span><br><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">update</span></span><br></pre></td></tr></table></figure>

<p>Create Table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- auto-generated definition</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> orders</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    name        <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">null</span>,</span><br><span class="line">    description text         <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Remember to add @Repository on Jpa class, which I forgot and error.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Order, Integer&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Useful mysql style guide: <a target="_blank" rel="noopener" href="https://www.sqlstyle.guide/">https://www.sqlstyle.guide/</a></p>
<h3 id="Zipkin"><a href="#Zipkin" class="headerlink" title="Zipkin"></a>Zipkin</h3><p>Run zipkin in docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9411:9411 openzipkin/zipkin</span><br></pre></td></tr></table></figure>

<p>Check by visiting <a target="_blank" rel="noopener" href="http://localhiost:9411/">http://localhiost:9411/</a></p>
<p>Reference: <a target="_blank" rel="noopener" href="https://zipkin.io/pages/quickstart.html">https://zipkin.io/pages/quickstart.html</a></p>
<h2 id="Add-Zipkin-and-Sleuth-pom"><a href="#Add-Zipkin-and-Sleuth-pom" class="headerlink" title="Add Zipkin and Sleuth pom"></a>Add Zipkin and Sleuth pom</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Develop-Logic-and-Call"><a href="#Develop-Logic-and-Call" class="headerlink" title="Develop Logic and Call"></a>Develop Logic and Call</h2><p>OrderController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/orders&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(<span class="meta">@RequestBody</span> Order order)</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">newOrder</span> <span class="operator">=</span> orderService.createOrder(order);</span><br><span class="line">        System.out.println(restTemplate.getForObject(<span class="string">&quot;http://localhost:8101/payments&quot;</span>, Payment.class));</span><br><span class="line">        <span class="keyword">return</span> newOrder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PaymentController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.time.LocalTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/payments&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">paymentCount</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">makePayment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Payment.builder().id(paymentCount++).createAt(LocalTime.now()).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getDummyPayment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Payment.builder().id(-<span class="number">1</span>).createAt(LocalTime.MIDNIGHT).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Postman endpoint</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST http://localhost:8100/orders</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;iphone SE2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Check Zipkin</p>
<p><img src="/images/zipkin.png" alt="zipkin"></p>
<p>Here we can see the executing duration of two microservices.</p>
<h1 id="Debug-Collections"><a href="#Debug-Collections" class="headerlink" title="Debug Collections"></a>Debug Collections</h1><ol>
<li><p><strong>After Adding spring cloud version dependency cause error, error info</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to introspect Class [org.springframework.cloud.context.properties.ConfigurationPropertiesBeans] from ClassLoader [jdk.internal.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getting Spring Boot [2.7.0] is not compatible with this Spring Cloud release train error</span><br></pre></td></tr></table></figure>



<p>pom.xml added content</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Reason:  The class in the issue title is part of Spring Cloud and that’s all the information that you’ve provided. Spring Cloud version does not fit with spring boot. Check table from official spring cloud below.</p>
<blockquote>
<table>
<thead>
<tr>
<th>Release Train</th>
<th>Release Train</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2022.0-Release-Notes">2022.0.x</a> aka Kilburn</td>
<td>3.0.x</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2021.0-Release-Notes">2021.0.x</a> aka Jubilee</td>
<td>2.6.x, 2.7.x (Starting with 2021.0.3)</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes">2020.0.x</a> aka Ilford</td>
<td>2.4.x, 2.5.x (Starting with 2020.0.3)</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes">Hoxton</a></td>
<td>2.2.x, 2.3.x (Starting with SR5)</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Greenwich-Release-Notes">Greenwich</a></td>
<td>2.1.x</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Finchley-Release-Notes">Finchley</a></td>
<td>2.0.x</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Edgware-Release-Notes">Edgware</a></td>
<td>1.5.x</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Dalston-Release-Notes">Dalston</a></td>
<td>1.5.x</td>
</tr>
</tbody></table>
</blockquote>
<p>Solution: find 2.7.x compatible one</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Reference: <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/issues/29521">Failed to introspect Class(Github)</a>, <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud#overview">Release train Spring Boot compatibility</a>, [getting Spring Boot <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/72359609/getting-spring-boot-2-7-0-is-not-compatible-with-this-spring-cloud-release-tra">2.7.0] is not compatible with this Spring Cloud release train error</a></p>
</li>
<li><p>POST method entity does not provide <code>id</code>.</p>
<p>Solution: modify database id with auto_increment &#x3D; 1.</p>
</li>
</ol>
<h1 id="Learing-Tutorial-Reference"><a href="#Learing-Tutorial-Reference" class="headerlink" title="Learing Tutorial Reference"></a>Learing Tutorial Reference</h1><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=M19XC0zJUrA">Microservice | Distributed log tracing using Spring Cloud Sleuth &amp; Zipkin | PART-7 | Javatechie</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Java-Techie-jt/spring-cloud-gatway-hystrix">https://github.com/Java-Techie-jt/spring-cloud-gatway-hystrix</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/30/Volatile-in-Java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/30/Volatile-in-Java/" class="post-title-link" itemprop="url">Volatile in Java</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-30 13:19:09 / Modified: 13:33:41" itemprop="dateCreated datePublished" datetime="2023-06-30T13:19:09-05:00">2023-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/domain-knowledge/" itemprop="url" rel="index"><span itemprop="name">domain knowledge</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Volatile-keyword-in-Java"><a href="#Volatile-keyword-in-Java" class="headerlink" title="Volatile keyword in Java"></a><code>Volatile</code> keyword in Java</h1><p><code>Volatile</code> is usually used in multi-threading environment. It makes sure <u>a variable value</u> directly write into <strong>main memory</strong>.</p>
<p>In addition, it also prevents instructions reorder.</p>
<p>Previously, I had a mistake idea that <code>Volatile</code> also belongs to synchronization like <code>synchronzied</code>. But <em>de facto</em>, it is not.</p>
<p><code>Volatile</code> just guarantee <strong>visibility</strong>.</p>
<p>The wrong idea is from following: I used following code to present <code>volatile</code> could get expected result even under race condition. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    List&lt;Thread&gt; tasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            count++;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;);</span><br><span class="line">        tasks.add(thread);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Thread thread : tasks) &#123;</span><br><span class="line">        thread.join();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(count); <span class="comment">// 2000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The expected result is 2000 and everytime I got 2000, which misleads me. But actually, there is error in above code.</p>
<p><strong>All 1000 tasks are starting in a sequential order</strong>. There are time lag between each iteration. For example, thread - 0 (<code>i</code> &#x3D; 0) starts before thread - 1(<code>i</code> &#x3D; 1).</p>
<p>Revised code: By adding random sleep time for each thread, threads starting early could execute second <code>count++</code> after those later threads.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    List&lt;Thread&gt; tasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">100</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;);</span><br><span class="line">        tasks.add(thread);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Thread thread : tasks) &#123;</span><br><span class="line">        thread.join();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(count); <span class="comment">//1964</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The result here shows <code>volatile</code>  cannot guarantee expected result.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/15/Elasticsearch-Mapping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/15/Elasticsearch-Mapping/" class="post-title-link" itemprop="url">Elasticsearch - Mapping</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-15 17:50:54 / Modified: 18:04:50" itemprop="dateCreated datePublished" datetime="2023-06-15T17:50:54-05:00">2023-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Learning-Note/" itemprop="url" rel="index"><span itemprop="name">Learning Note</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h1><p>Mapping is used to describe mapping constraints or “how to map”. It is in <code>json</code> format.</p>
<p>Here are some common properties of mapping:</p>
<ul>
<li>type: the data type<ul>
<li>String: text (could be split), keyword (could not be split, such as brand, country name, IP address)</li>
<li>Number: long, integer, short, byte, double, float</li>
<li>Bool: boolean</li>
<li>Date: date</li>
<li>Complex Object</li>
</ul>
</li>
</ul>
<blockquote>
<p>Note there is no array, but allow repeat elements</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;number&quot;</span> <span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line"> 	<span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">8.9</span></span><br><span class="line">  <span class="attr">&quot;healthy&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;info&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;This is info&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rate&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;complex&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;p1&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;p2&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Index: default value is <code>true</code>, means current field could be used to created inverted index. If do not want this field in index, use <code>false</code>.</li>
<li>analyzer: used for text to split</li>
<li>properties: properties of the field (used in complex or the field is object)</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/15/Deploy-Elasticsearch-and-Kibana-in-Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/shiba.jpeg">
      <meta itemprop="name" content="Kevin Duan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Kevin's Personal Tech Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/15/Deploy-Elasticsearch-and-Kibana-in-Docker/" class="post-title-link" itemprop="url">Deploy Elasticsearch and Kibana in Docker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-15 16:37:13 / Modified: 22:22:34" itemprop="dateCreated datePublished" datetime="2023-06-15T16:37:13-05:00">2023-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/manual/" itemprop="url" rel="index"><span itemprop="name">manual</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Deploy-Elasticsearch-and-Kibana-in-Docker"><a href="#Deploy-Elasticsearch-and-Kibana-in-Docker" class="headerlink" title="Deploy Elasticsearch and Kibana in Docker"></a>Deploy Elasticsearch and Kibana in Docker</h1><h2 id="Run-Elasticsearch-Container-in-Docker"><a href="#Run-Elasticsearch-Container-in-Docker" class="headerlink" title="Run Elasticsearch Container in Docker"></a>Run Elasticsearch Container in Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker network create elastic</span><br><span class="line">docker pull docker.elastic.co/elasticsearch/elasticsearch:7.17.10</span><br><span class="line">docker run --name es01-test --net elastic -p 127.0.0.1:9200:9200 -p 127.0.0.1:9300:9300 -e &quot;discovery.type=single-node&quot; docker.elastic.co/elasticsearch/elasticsearch:7.17.10</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Here <code>elastic</code> network is required since kibana needs to communicate with elasticsearch. </p>
<p>Check by visiting <a target="_blank" rel="noopener" href="http://localhost:9200/">http://localhost:9200</a>.</p>
<blockquote>
<ul>
<li><code>docker run</code>: This command is used to create and run a new Docker container.</li>
<li><code>--name es01-test</code>: It specifies the name of the container, which in this case is set as “es01-test”. You can provide any desired name for your container.</li>
<li><code>--net elastic</code>: It specifies the network to which the container should be attached. In this case, it is connected to a network named “elastic”. Make sure this network is already created or Docker will create it for you.</li>
<li><code>-p 127.0.0.1:9200:9200</code>: This option specifies the port mapping between the host machine and the container. It binds port 9200 of the host to port 9200 of the container. This is the default port for Elasticsearch’s REST API, allowing you to access Elasticsearch from your host machine via <code>http://localhost:9200</code>.</li>
<li><code>-p 127.0.0.1:9300:9300</code>: This option binds port 9300 of the host to port 9300 of the container. Port 9300 is used for Elasticsearch’s transport layer, which enables communication between Elasticsearch nodes in a cluster.</li>
<li><code>-e &quot;discovery.type=single-node&quot;</code>: This option sets an environment variable within the container. Here, it configures Elasticsearch to run in a single-node mode, suitable for development or testing purposes.</li>
<li><code>docker.elastic.co/elasticsearch/elasticsearch:7.17.10</code>: This specifies the Docker image to use for creating the container. In this case, it uses the official Elasticsearch image with version 7.17.10. Docker will download the image if it doesn’t exist locally.</li>
</ul>
</blockquote>
<h2 id="Run-Kibana-Container-in-Docker"><a href="#Run-Kibana-Container-in-Docker" class="headerlink" title="Run Kibana Container in Docker"></a>Run Kibana Container in Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/kibana/kibana:7.17.10</span><br><span class="line">docker run --name kib01-test --net elastic -p 127.0.0.1:5601:5601 -e &quot;ELASTICSEARCH_HOSTS=http://es01-test:9200&quot; docker.elastic.co/kibana/kibana:7.17.10</span><br></pre></td></tr></table></figure>

<p>It is better to keep the same version with elasticsearch.</p>
<p>Check by visiting <a target="_blank" rel="noopener" href="http://localhost:5601/">http://localhost:5601</a>.</p>
<h2 id="Stop-Containers"><a href="#Stop-Containers" class="headerlink" title="Stop Containers"></a>Stop Containers</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop es01-test</span><br><span class="line">docker stop kib01-test</span><br></pre></td></tr></table></figure>

<h2 id="Remove-Containers"><a href="#Remove-Containers" class="headerlink" title="Remove Containers"></a>Remove Containers</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker network rm elastic</span><br><span class="line">docker rm es01-test</span><br><span class="line">docker rm kib01-test</span><br></pre></td></tr></table></figure>



<p>Reference: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/7.17/docker.html#docker">Elastic guide Kibana 7.17</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin Duan</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>


    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
